<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amway test</title>
  <link rel="stylesheet" href="./guide/guide.css">
  <script src="./guide/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
  <div id="app" @keydown.esc="showLayer = false">
    <div class="page-list">
      <div class="page-list__tabs">
        <button class="page-list__tab" v-for="(tab, t) in pageList" :key="t" @click="activeTab = t"
          :class="{'active': activeTab === t}" v-if="!viewAll">{{ tab.title}}</button>
        <!-- <p class="page-list__notice">테이블 상단 위치 / 최종수정일 버튼 클릭으로 정렬방식 변경</p> -->
        <a href="/_ui/apro/index.html" class="page-list__tab" v-if="!viewAll" target="_blank"
          style="font-weight: 700;">A Pro</a>
        <button class="page-list__view-all" :class="{'view-all': viewAll}" @click="changeList()">
          {{ viewAll ? '탭으로 구분' : '전체 목록(A Pro 제외)' }}
        </button>
      </div>
      <div class="page-list__content">
        <div class="page-list__header">
          <div class="page-list__name">페이지아이디</div>
          <div class="page-list__level">
            <button type="button" class="sorting" :class="{ 'asc': orderLevel === 'asc' }"
              @click="sortingType('level')">
              위치
            </button>
          </div>
          <div class="page-list__date">
            <button type="button" class="sorting" :class="{ 'asc': orderBy === 'asc' }" @click="sortingType('date')">
              최종수정일
            </button>
          </div>
          <div class="page-list__link">형태</div>
          <div class="page-list__type">링크</div>
          <div class="page-list__history">수정이력</div>
          <div class="page-list__etc">최종 수정내용</div>
        </div>
        <!-- URL -->
        <template v-if="viewAll">
          <div v-for="(item, i) in pageList" v-if="!item.hide" :key="i"
            :class="{active : showLayer && currentIndex === i, recent: item.pageId !== '' && pageID === item.pageId, hide: item.hide}"
            class="page-list__item">
            <!-- 페이지명 -->
            <div class="page-list__name">{{ item.pageId }}</div>
            <!-- 카테고리 -->
            <div class="page-list__level">
              <div class="level-child" v-for="(array, a) in item.level">{{ `${array}` }}</div>
            </div>
            <!-- 날짜 -->
            <div class="page-list__date">{{ item.update ? getDate(item.update) : '' }}</div>
            <!-- 형태 -->
            <div class="page-list__type">
              <span v-for="(pt, y) in item.pageType">{{ pt }}</span>
            </div>
            <!-- 링크 -->
            <div class="page-list__link">
              <template v-if="typeof item.url === 'object'">
                <a :href="`./${item.url[0]}`" target="_blank" class="link">상품상세</a>
                <a :href="`./${item.url[1]}`" target="_blank" class="link">정보제공</a>
              </template>
              <template v-else="v-else">
                <a :href="`./${item.url}`" target="_blank" class="link" @click="activeLink(item.pageId)">링크</a>
              </template>
            </div>
            <!-- 수정이력 -->
            <div class="page-list__history">
              <button type="button" class="button" v-if="item.history" @click="openLayer(item, i)"
                @mouseenter="testMethod(item, i)">수정이력</button>
              <div class="tooltip">
                <div class="history-layer__item" v-for="(history, h) in historyData.list" :key="h">
                  <div class="history-layer__date">{{ getDate(history.date) }}</div>
                  <div class="history-layer__note">{{ history.note }}</div>
                </div>
              </div>
            </div>
            <div class="page-list__etc">{{ item.memo }}</div>
          </div>
        </template>
        <template v-else="v-else">
          <div v-for="(pages, p) in pageList" :key="p" v-if="activeTab === p">
            <div v-for="(item, i) in pages.pages" v-if="!item.hide" :key="i"
              :class="{active : showLayer && currentIndex === i, recent: item.pageId !== '' && pageID === item.pageId, hide: item.hide}"
              class="page-list__item">
              <!-- 페이지명 -->
              <div class="page-list__name">{{ item.pageId }}</div>
              <!-- 카테고리 -->
              <div class="page-list__level">
                <div class="level-child" v-for="(array, a) in item.level">{{ `${array}` }}</div>
              </div>
              <!-- 날짜 -->
              <div class="page-list__date">{{ item.update ? getDate(item.update) : '' }}</div>
              <!-- 형태 -->
              <div class="page-list__type">
                <span v-for="(pt, y) in item.pageType">{{ pt }}</span>
              </div>
              <!-- 링크 -->
              <div class="page-list__link">
                <template v-if="typeof item.url === 'object'">
                  <a :href="`./${item.url[0]}`" target="_blank" class="link">상품상세</a>
                  <a :href="`./${item.url[1]}`" target="_blank" class="link">정보제공</a>
                </template>
                <template v-else="v-else">
                  <a :href="`./${item.url}`" target="_blank" class="link" @click="activeLink(item.pageId)">링크</a>
                </template>
              </div>
              <!-- 수정이력 -->
              <div class="page-list__history">
                <button type="button" class="button" v-if="item.history" @click="openLayer(item, i)"
                  @mouseenter="testMethod(item, i)">수정이력</button>
                <div class="tooltip">
                  <div class="history-layer__item" v-for="(history, h) in historyData.list" :key="h">
                    <div class="history-layer__date">{{ getDate(history.date) }}</div>
                    <div class="history-layer__note">{{ history.note }}</div>
                  </div>
                </div>
              </div>
              <div class="page-list__etc">{{ item.memo }}</div>
            </div>
          </div>
        </template>
      </div>
      <div class="history-layer" v-show="showLayer">
        <div class="history-layer__content">
          <div class="history-layer__header">
            {{ `${historyData.name} 수정 내역` }}
          </div>
          <div class="history-layer__item" v-for="(history, h) in historyData.list" :key="h">
            <div class="history-layer__date">{{ getDate(history.date) }}</div>
            <div class="history-layer__note">{{ history.note }}</div>
          </div>
          <div class="history-layer__footer">
            <button type="button" class="history-layer__button" @click="showLayer = false">닫기</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="./guide/lodash.js"></script>
  <script src="./guide/moment.js"></script>
  <script>
    const app = new Vue({
      el: '#app',
      data: {
        pages: [],
        history: [],
        showLayer: false,
        historyData: {},
        currentIndex: 0,
        orderLevel: 'default',
        orderBy: 'default',
        activeTab: 0,
        viewAll: false,
        handleDebouncedScroll: 0,
        pageID: ''
      },
      mounted() {
        const dataUrl = './guide/pages.json';
        const historyUrl = './guide/history.json';

        axios
          .get(dataUrl)
          .then((response) => {
            this.pages = response.data;
          });
        axios
          .get(historyUrl)
          .then((response) => {
            this.history = response.data;
          });
      },
      computed: {
        // 모바일 구분
        isMobile() {
          return (
            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
          );
        },
        // viewAll() {   let bool = false   return bool },
        pageList() {
          let pages = this.pages;
          const reversion = this.history;
          const pageList = [];
          let order = [];

          _.forEach(pages, (item) => {
            const list = {
              title: item.title,
              pages: this.makePage(item.list, reversion)
            }
            if (this.viewAll) {
              list
                .pages
                .forEach((pg) => {
                  pageList.push(pg)
                })
            } else {
              pageList.push(list);
            }
          });

          if (this.viewAll) {
            order = pageList
            if (this.orderBy === 'asc') {
              order = _
                .sortBy(pageList, 'update')
                .reverse();
              console.log(pageList)
            }
            if (this.orderLevel === 'asc') {
              order = _.sortBy(pageList, 'level');
            }
          }

          return this.viewAll
            ? order
            : pageList;
        }
      },
      methods: {
        changeList() {
          this.viewAll = !this.viewAll
        },
        makePage(pages, reversion) {
          _.forEach(pages, (item, idx) => {
            item.update = '';
          });
          _.forEach(reversion, (historyList, i) => {
            _.forEach(pages, (item, idx) => {
              if (item.pageId === historyList.pageId) {
                const order = _.sortBy(historyList.history, 'date');
                _.forEach(order, (date) => {
                  item.update = date.date;
                  item.memo = date.note;
                });
                item.history = order;
              }
            });
          });

          if (this.orderBy === 'asc') {
            pages = _
              .sortBy(pages, 'update')
              .reverse();
          }
          if (this.orderLevel === 'asc') {
            pages = _.sortBy(pages, 'level');
          }

          return pages;
        },
        sortingType(type) {
          if (type === 'date') {
            this.orderLevel = 'default';
            this.orderBy = this.orderBy === 'asc'
              ? 'default'
              : 'asc';
          } else {
            this.orderBy = 'default';
            this.orderLevel = this.orderLevel === 'asc'
              ? 'default'
              : 'asc';
          }
        },
        makeUrl(memo) {
          const splitMemo = memo.split(':')

          if (splitMemo[0] === 'http' || splitMemo[0] === 'https') {
            const link = splitMemo.join(':')
            return `<a href="${link.replace(/\,/g, '')}" target="_blank" class="url">URL</a>`;
          } else {
            return memo;
          }

        },
        openLayer(itemData, idx) {
          this.historyData = {
            name: itemData.pageId,
            list: itemData.history
          }
          this.showLayer = true;
          this.currentIndex = idx;
        },
        getDate(date) {
          const returnDate = moment(date).format('YYYY-MM-DD');

          return returnDate;
        },
        activeLink(pageID) {
          this.pageID = pageID
        },
        testMethod(itemData, idx) {
          this.historyData = {
            name: itemData.pageId,
            list: itemData.history
          }
        }
      }
    })
  </script>
</body>

</html>